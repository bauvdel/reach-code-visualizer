<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REACH Code Visualizer</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- vis.js Network -->
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <!-- html2canvas for export -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Header with Toolbar -->
        <header class="app-header">
            <div class="header-brand">
                <i class="bi bi-diagram-3"></i>
                <span>REACH Code Visualizer</span>
            </div>

            <!-- Toolbar -->
            <div class="toolbar">
                <div class="toolbar-group">
                    <div class="dropdown">
                        <button class="toolbar-btn dropdown-toggle" data-bs-toggle="dropdown" title="Layout">
                            <i class="bi bi-grid-3x3"></i> Layout
                        </button>
                        <ul class="dropdown-menu dropdown-menu-dark">
                            <li><a class="dropdown-item layout-option active" data-layout="force">Force-Directed</a></li>
                            <li><a class="dropdown-item layout-option" data-layout="hierarchical">Hierarchical</a></li>
                            <li><a class="dropdown-item layout-option" data-layout="circular">Circular</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" id="toggle-physics"><i class="bi bi-check"></i> Physics Enabled</a></li>
                        </ul>
                    </div>
                </div>

                <div class="toolbar-group">
                    <button id="toggle-filter-panel" class="toolbar-btn" title="Toggle Filters (Ctrl+Shift+F)">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                    <button id="toggle-focus-mode" class="toolbar-btn" title="Focus Mode (F)">
                        <i class="bi bi-bullseye"></i> Focus
                    </button>
                    <button id="find-path-btn" class="toolbar-btn" title="Find Path">
                        <i class="bi bi-signpost-split"></i> Path
                    </button>
                    <button id="clear-highlights-btn" class="toolbar-btn" title="Clear Highlights">
                        <i class="bi bi-eraser"></i> Clear
                    </button>
                </div>

                <div class="toolbar-group">
                    <button id="toggle-bookmarks" class="toolbar-btn" title="Bookmarks (Ctrl+B)">
                        <i class="bi bi-bookmark"></i> Bookmarks
                    </button>
                    <div class="dropdown">
                        <button class="toolbar-btn dropdown-toggle" data-bs-toggle="dropdown" title="Export">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <ul class="dropdown-menu dropdown-menu-dark">
                            <li><a class="dropdown-item" id="export-png"><i class="bi bi-image"></i> Export as PNG</a></li>
                            <li><a class="dropdown-item" id="export-svg"><i class="bi bi-filetype-svg"></i> Export as SVG</a></li>
                            <li><a class="dropdown-item" id="export-json"><i class="bi bi-filetype-json"></i> Export as JSON</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" id="copy-link"><i class="bi bi-link-45deg"></i> Copy Shareable Link</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="search-container">
                <div class="search-wrapper">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" id="search-input" class="search-input"
                           placeholder="Search: name, /regex/, 'what calls X?', 'path from A to B'">
                    <button id="search-btn" class="search-btn">
                        <i class="bi bi-arrow-right-circle"></i>
                    </button>
                </div>
                <div id="search-results" class="search-results"></div>
            </div>

            <div class="header-actions">
                <button id="settings-btn" class="action-btn" title="Settings">
                    <i class="bi bi-gear"></i>
                </button>
                <button id="help-btn" class="action-btn" title="Keyboard Shortcuts (?)">
                    <i class="bi bi-question-circle"></i>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Left Sidebar (Filter Panel) -->
            <aside id="filter-panel" class="filter-panel collapsed">
                <div class="panel-header">
                    <h4><i class="bi bi-funnel"></i> Filters</h4>
                    <button id="close-filter-panel" class="close-btn"><i class="bi bi-x-lg"></i></button>
                </div>
                <div class="panel-content">
                    <!-- Node Type Filter -->
                    <div class="filter-section">
                        <h5>Node Types</h5>
                        <div class="filter-checkboxes">
                            <label><input type="checkbox" class="type-filter" value="FUNCTION" checked> Functions</label>
                            <label><input type="checkbox" class="type-filter" value="VARIABLE" checked> Variables</label>
                            <label><input type="checkbox" class="type-filter" value="SIGNAL" checked> Signals</label>
                            <label><input type="checkbox" class="type-filter" value="CLASS" checked> Classes</label>
                            <label><input type="checkbox" class="type-filter" value="SCENE" checked> Scenes</label>
                            <label><input type="checkbox" class="type-filter" value="SIGNAL_CONNECTION" checked> Connections</label>
                        </div>
                    </div>

                    <!-- Language Filter -->
                    <div class="filter-section">
                        <h5>Language</h5>
                        <div class="filter-checkboxes">
                            <label><input type="checkbox" class="lang-filter" value="gdscript" checked> GDScript</label>
                            <label><input type="checkbox" class="lang-filter" value="scene" checked> Scene Files</label>
                        </div>
                    </div>

                    <!-- Confidence Filter -->
                    <div class="filter-section">
                        <h5>Confidence</h5>
                        <div class="filter-checkboxes">
                            <label><input type="checkbox" class="conf-filter" value="high" checked> High</label>
                            <label><input type="checkbox" class="conf-filter" value="medium" checked> Medium</label>
                            <label><input type="checkbox" class="conf-filter" value="low" checked> Low</label>
                            <label><input type="checkbox" class="conf-filter" value="ambiguous" checked> Ambiguous</label>
                        </div>
                    </div>

                    <!-- Directory Filter -->
                    <div class="filter-section">
                        <h5>Directory</h5>
                        <input type="text" id="dir-filter" class="filter-input" placeholder="e.g., src/player/">
                    </div>

                    <!-- Custom Filter -->
                    <div class="filter-section">
                        <h5>Custom Filter</h5>
                        <input type="text" id="custom-filter" class="filter-input" placeholder="name contains 'save'">
                    </div>

                    <!-- Cluster Controls -->
                    <div class="filter-section">
                        <h5>Clustering</h5>
                        <div class="cluster-controls">
                            <label>Cluster by:</label>
                            <select id="cluster-by" class="filter-select">
                                <option value="none">None</option>
                                <option value="file">File</option>
                                <option value="directory">Directory</option>
                            </select>
                            <label>Threshold: <span id="cluster-threshold-value">500</span></label>
                            <input type="range" id="cluster-threshold" min="50" max="1000" value="500" step="50">
                        </div>
                    </div>

                    <div class="filter-actions">
                        <button id="apply-filters" class="btn-primary">Apply Filters</button>
                        <button id="reset-filters" class="btn-secondary">Reset</button>
                    </div>
                </div>
            </aside>

            <!-- Bookmarks Panel -->
            <aside id="bookmarks-panel" class="bookmarks-panel collapsed">
                <div class="panel-header">
                    <h4><i class="bi bi-bookmark"></i> Bookmarks</h4>
                    <button id="close-bookmarks" class="close-btn"><i class="bi bi-x-lg"></i></button>
                </div>
                <div class="panel-content">
                    <button id="save-bookmark" class="btn-primary btn-block">
                        <i class="bi bi-bookmark-plus"></i> Save Current View
                    </button>
                    <div id="bookmarks-list" class="bookmarks-list">
                        <p class="text-muted">No bookmarks yet</p>
                    </div>
                    <div class="bookmark-actions">
                        <button id="export-bookmarks" class="btn-sm btn-secondary">Export</button>
                        <button id="import-bookmarks" class="btn-sm btn-secondary">Import</button>
                    </div>
                </div>
            </aside>

            <!-- Graph Container -->
            <div class="graph-panel">
                <!-- Focus Mode Banner -->
                <div id="focus-banner" class="focus-banner hidden">
                    <span class="focus-label">
                        <i class="bi bi-bullseye"></i> Focused on: <strong id="focus-node-name">--</strong>
                    </span>
                    <div class="focus-controls">
                        <label>Depth: </label>
                        <input type="range" id="focus-depth" min="1" max="5" value="2">
                        <span id="focus-depth-value">2</span>
                        <button id="exit-focus" class="btn-sm btn-secondary">Exit Focus</button>
                    </div>
                </div>

                <!-- Path Mode Banner -->
                <div id="path-banner" class="path-banner hidden">
                    <span class="path-label">
                        <i class="bi bi-signpost-split"></i> Path Mode:
                        <span id="path-status">Click first node</span>
                    </span>
                    <button id="cancel-path" class="btn-sm btn-secondary">Cancel</button>
                </div>

                <div id="graph-container"></div>

                <!-- Graph Controls -->
                <div class="graph-controls">
                    <button id="zoom-in" class="control-btn" title="Zoom In (+)">
                        <i class="bi bi-zoom-in"></i>
                    </button>
                    <button id="zoom-out" class="control-btn" title="Zoom Out (-)">
                        <i class="bi bi-zoom-out"></i>
                    </button>
                    <button id="center-btn" class="control-btn" title="Center (Space)">
                        <i class="bi bi-bullseye"></i>
                    </button>
                    <button id="fit-btn" class="control-btn" title="Fit All">
                        <i class="bi bi-fullscreen"></i>
                    </button>
                </div>

                <!-- Mini-map -->
                <div id="minimap" class="minimap">
                    <div class="minimap-header">
                        <span>Overview</span>
                        <button id="toggle-minimap" class="minimap-toggle">
                            <i class="bi bi-dash"></i>
                        </button>
                    </div>
                    <div id="minimap-canvas" class="minimap-canvas"></div>
                </div>

                <!-- Loading Overlay -->
                <div id="loading-overlay" class="loading-overlay">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="loading-text">Loading graph...</div>
                </div>
            </div>

            <!-- Inspector Panel (Right) -->
            <aside id="inspector-panel" class="inspector-panel">
                <div class="inspector-header">
                    <h3>Node Inspector</h3>
                    <button id="close-inspector" class="close-btn"><i class="bi bi-x-lg"></i></button>
                </div>

                <!-- Inspector Tabs -->
                <div class="inspector-tabs">
                    <button class="tab-btn active" data-tab="details">Details</button>
                    <button class="tab-btn" data-tab="relationships">Relations</button>
                    <button class="tab-btn" data-tab="code">Code</button>
                </div>

                <div id="inspector-content" class="inspector-content">
                    <div class="inspector-placeholder">
                        <i class="bi bi-cursor-fill"></i>
                        <p>Click a node to inspect</p>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-left">
                <span id="status-nodes"><i class="bi bi-circle-fill text-primary"></i> <span class="status-value">0</span> nodes</span>
                <span id="status-edges"><i class="bi bi-arrow-right"></i> <span class="status-value">0</span> edges</span>
                <span id="status-visible"><i class="bi bi-eye"></i> <span class="status-value">0</span> visible</span>
                <span id="status-clusters" class="hidden"><i class="bi bi-boxes"></i> <span class="status-value">0</span> clusters</span>
            </div>
            <div class="status-center"><span id="status-message"></span></div>
            <div class="status-right">
                <span id="status-mode" class="hidden"></span>
                <span id="status-connection" class="status-connected"><i class="bi bi-wifi"></i> Connected</span>
                <span id="status-updated"><i class="bi bi-clock"></i> <span class="status-value">--</span></span>
            </div>
        </footer>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="setting-group">
                        <h6>Display</h6>
                        <label class="setting-item">
                            <input type="checkbox" id="setting-show-labels" checked> Show node labels
                        </label>
                        <label class="setting-item">
                            <input type="checkbox" id="setting-show-edge-labels"> Show edge labels
                        </label>
                        <label class="setting-item">
                            <input type="checkbox" id="setting-show-minimap" checked> Show mini-map
                        </label>
                    </div>
                    <div class="setting-group">
                        <h6>Performance</h6>
                        <label>Max visible nodes: <span id="max-nodes-value">500</span></label>
                        <input type="range" id="setting-max-nodes" min="100" max="2000" value="500" step="100">
                        <label class="setting-item">
                            <input type="checkbox" id="setting-lazy-load" checked> Lazy load nodes
                        </label>
                    </div>
                    <div class="setting-group">
                        <h6>Physics</h6>
                        <label>Node spacing: <span id="spacing-value">100</span></label>
                        <input type="range" id="setting-spacing" min="50" max="200" value="100" step="10">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="save-settings">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-keyboard"></i> Keyboard Shortcuts</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body shortcuts-list">
                    <div class="shortcut-group">
                        <h6>Navigation</h6>
                        <div class="shortcut"><kbd>Space</kbd> Center graph</div>
                        <div class="shortcut"><kbd>+</kbd> / <kbd>-</kbd> Zoom in/out</div>
                        <div class="shortcut"><kbd>F</kbd> Focus on selected node</div>
                        <div class="shortcut"><kbd>Escape</kbd> Exit focus / clear selection</div>
                    </div>
                    <div class="shortcut-group">
                        <h6>Search & Filter</h6>
                        <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>F</kbd> Focus search</div>
                        <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>F</kbd> Toggle filters</div>
                        <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>H</kbd> Clear highlights</div>
                    </div>
                    <div class="shortcut-group">
                        <h6>Views</h6>
                        <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>B</kbd> Toggle bookmarks</div>
                        <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>L</kbd> Cycle layouts</div>
                        <div class="shortcut"><kbd>?</kbd> Show this help</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Bookmark Modal -->
    <div id="bookmark-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save Bookmark</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="bookmark-name" class="form-control" placeholder="Bookmark name...">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-bookmark">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JS - Order matters -->
    <script src="/js/api-client.js"></script>
    <script src="/js/graph-renderer.js"></script>
    <script src="/js/filters.js"></script>
    <script src="/js/path-highlighter.js"></script>
    <script src="/js/clustering.js"></script>
    <script src="/js/focus-mode.js"></script>
    <script src="/js/minimap.js"></script>
    <script src="/js/bookmarks.js"></script>
    <script src="/js/node-inspector.js"></script>
    <script src="/js/query-interface.js"></script>
    <script src="/js/export.js"></script>
    <script src="/js/keyboard-shortcuts.js"></script>
    <script src="/js/main.js"></script>
</body>
</html>
